#user  nobody;
worker_processes  auto;

error_log  logs/error.log   warn;

pid        logs/nginx.pid;

events {
    worker_connections 512;
    multi_accept on;
    use epoll;
    accept_mutex on;

}


stream {
    # 根据 TLS SNI（域名）动态选择后端
    map $ssl_preread_server_name $backend_name {
        cloud.knauf.quest xray_reality_backend;    # 若 SNI 为 cloud.ffe.quest，转发到 xray_reality_backend
        doh.knauf.quest dns_backend;
        ip.knauf.quest ipcheck_backend; #IP查询
        default web_backend;            # 其他域名转发到 web_backend
    }

    # 定义 TCP 后端
    upstream xray_reality_backend {
        server 127.0.0.1:1554;         # 本地 1554 端口（用于 Reality 协议）
    }
    
    upstream dns_backend {
        server 127.0.0.1:2999;         # 本地 2999 端口（用于 DNS面板）
    }

    upstream dns_backend {
        server 127.0.0.1:1562;         # 本地 1562 端口（用于 IP检测）
    }

    upstream web_backend {
    server 127.0.0.1:8443 max_fails=3 fail_timeout=10s;
    zone backend 64k;
    }

    # 定义 UDP 后端（如 Hysteria 协议）
    upstream hysteria_backend {
        server 127.0.0.1:1553 ;          # 本地 1553 端口（UDP 服务）
    }    

    # TCP 代理服务器（处理 HTTPS 流量）
    server {
        listen 443;                     # 监听 IPv4 443 端口
        listen [::]:443;                # 监听 IPv6 443 端口
        ssl_preread    on;              # 启用 SNI 预读
        proxy_pass     $backend_name;   # 根据 SNI 动态选择后端
        proxy_protocol on;              # 启用 Proxy Protocol（传递客户端真实 IP）
    }

    # UDP 代理服务器（处理 Hysteria 等 UDP 协议）
    server {       
        listen 443 udp reuseport;       # 监听 UDP 443 端口（reuseport 提升性能）
        listen [::]:443 udp reuseport;
        proxy_pass    hysteria_backend; # 转发到 Hysteria 后端
        proxy_timeout 10s;              # UDP 代理超时时间
    }

}


http {
    server_tokens off;                  # 隐藏 Nginx 版本号
    include       mime.types;           # 包含 MIME 类型文件
    default_type  application/octet-stream;
    client_max_body_size 50m;

    map $http_x_forwarded_for $clientRealIp {
        "" $remote_addr;
        "~*(?P<firstAddr>([0-9a-f]{0,4}:){1,7}[0-9a-f]{1,4}|([0-9]{1,3}\.){3}[0-9]{1,3})$" $firstAddr;
    }

    log_format main '$clientRealIp $remote_addr $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" $http_x_forwarded_for '
                    '"$upstream_addr" "$upstream_status" "$upstream_response_time" "$request_time" ';
    access_log       logs/access.log main buffer=32k flush=5s;

    sendfile          on;               # 启用高效文件传输
    tcp_nopush        on;
    keepalive_timeout 30;               # 保持连接超时时间

    # Gzip 压缩配置
    gzip       on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_comp_level  2;
    # HTTP 强制跳转 HTTPS
    server {
        listen 80;
        listen [::]:80;
        return 301 https://$host$request_uri;  # 80 端口重定向到 HTTPS
    }

    # 新增 DNS 面板服务配置
    server {
        listen 127.0.0.1:2999 ssl proxy_protocol;                # 监听本地 2999 端口
        server_name doh.knauf.quest;            # 指定服务域名

        # 从 Proxy Protocol 头中提取真实客户端 IP
        set_real_ip_from 127.0.0.1;
        real_ip_header proxy_protocol;

        # SSL 证书配置（需单独为 private.ffe.quest 申请证书）
        ssl_certificate     /usr/local/nginx/certs/doh.knauf.quest/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/certs/doh.knauf.quest/cert.key;

        # SSL 安全配置（复用之前的参数）   
        ssl_stapling on;
        ssl_stapling_verify on;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers             'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers on;
        ssl_ecdh_curve          x25519:secp521r1:secp384r1:secp256r1;
        ssl_trusted_certificate /usr/local/nginx/certs/doh.knauf.quest/fullchain.cer;  # 证书链文件
        resolver 1.1.1.1 valid=1200s;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 60m;
        ssl_buffer_size 4k;

        # 安全响应头
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        # 反向代理到 DNS 面板
        location / {
            proxy_pass http://127.0.0.1:3001;  # 假设 DNS 面板运行在 3000 端口
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        location /dns-query {
            proxy_pass https://127.0.0.1:3000/dns-query;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_ssl_server_name on;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Server $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
    
    #新建IP检测服务
    server {
        listen 127.0.0.1:1562 ssl proxy_protocol;                # 监听本地 2999 端口
        server_name ip.knauf.quest;            # 指定服务域名

        # 从 Proxy Protocol 头中提取真实客户端 IP
        set_real_ip_from 127.0.0.1;
        real_ip_header proxy_protocol;

        # SSL 证书配置（需单独为 private.ffe.quest 申请证书）
        ssl_certificate     /usr/local/nginx/certs/ip.knauf.quest/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/certs/ip.knauf.quest/cert.key;

        # SSL 安全配置（复用之前的参数）   
        ssl_stapling on;
        ssl_stapling_verify on;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers             'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_prefer_server_ciphers on;
        ssl_ecdh_curve          x25519:secp521r1:secp384r1:secp256r1;
        ssl_trusted_certificate /usr/local/nginx/certs/doh.knauf.quest/fullchain.cer;  # 证书链文件
        resolver 1.1.1.1 valid=1200s;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 60m;
        ssl_buffer_size 4k;

        # 安全响应头
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options DENY;
        # 反向代理到 DNS 面板
        location /#/ {
            proxy_pass http://127.0.0.1:1561; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # HTTPS 服务器（处理 Web 和 gRPC 流量）
    server {
        listen 127.0.0.1:8443 quic reuseport;   # 监听 QUIC（HTTP/3）
        listen 127.0.0.1:8443 ssl proxy_protocol reuseport;  # 监听 HTTPS（HTTP/2）
        http2 on;    # 启用 HTTP/2

        # 从 Proxy Protocol 中获取真实 IP
        set_real_ip_from 127.0.0.1;
        real_ip_header   proxy_protocol;

        # SSL 证书配置
        ssl_certificate     /usr/local/nginx/certs/cloud.knauf.quest/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/certs/cloud.knauf.quest/cert.key;

        # SSL 协议和加密套件配置
        ssl_protocols             TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers               'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
        ssl_ecdh_curve            x25519:secp521r1:secp384r1:secp256r1;
        ssl_stapling on;
        ssl_stapling_verify on;
        ssl_trusted_certificate /usr/local/nginx/certs/cloud.knauf.quest/fullchain.cer;  # 证书链文件
        resolver 1.1.1.1 valid=1200s;

        location /1vJFzU47r {
            grpc_pass grpc://127.0.0.1:1551;
            grpc_set_header Host $host;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 普通 HTTP 请求代理
        location / {
            # 安全响应头
            add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
            add_header Alt-Svc 'h3=":443"; ma=86400';  # 声明支持 HTTP/3

            # 反向代理到本地 5244 端口（如 cloudreve 应用）
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   Host $host;
            proxy_pass         http://127.0.0.1:5244;
            proxy_set_header   X-Forwarded-Proto $scheme;
            
        }
    }
}
